*------------------------------------------------------------*
* Report Log
Date:                October 16, 2018
Time:                22:35:10
*------------------------------------------------------------*
19395  %let EMEXCEPTIONSTRING=;
19396  *------------------------------------------------------------*;
19397  * REPORT: TextTopic;
19398  *------------------------------------------------------------*;
19399  %let EM_ACTION = REPORT;
19400  %let syscc = 0;
19401  %macro main;
19402      %if %upcase(&EM_ACTION) = CREATE %then %do;
19403          filename temp catalog 'sashelp.emtxtext.topic_create.source';
19404          %include temp;
19405          %create;
19406      %end;
19407      %if %upcase(&EM_ACTION) = TRAIN %then %do;
19408          filename temp catalog 'sashelp.emtxtext.topic_train.source';
19409          %include temp;
19410          %train;
19411      %end;
19412     %if %upcase(&EM_ACTION) = SCORE %then %do;
19413          filename temp catalog 'sashelp.emtxtext.topic_score.source';
19414          %include temp;
19415          %score;
19416      %end;
19417      %if %upcase(&EM_ACTION) = REPORT %then %do;
19418          filename temp catalog 'sashelp.emtxtext.topic_report.source';
19419          %include temp;
19420          %report;
19421      %end;
19422  %mend main;
19423  
19424  %main;
NOTE: %INCLUDE (level 1) file TEMP is file SASHELP.EMTXTEXT.TOPIC_REPORT.SOURCE.
19425 +/* ****************************************************************
19426 + * Copyright (C) 2009 by SAS Institute Inc., Cary, NC 27513
19427 + *
19428 + * Name:             topic_report.sas
19429 + * Support:          cox  James A. Cox
19430 + * Product:          SAS/GRAPH
19431 + * Language:         Sas
19432 + * Script:
19433 + *
19434 + * Usage:
19435 + *
19436 + * Purpose:
19437 + *
19438 + * History:
19439 + * 03Jun09 Initial Coding [cox]
19440 + *
19441 + * Notes:
19442 + *
19443 + * Last Modified By:
19444 + * Last Modified On: Thu Oct 10 15:14:23 2013
19445 + *
19446 + * End
19447 + * ************************************************************** */
19448 +%macro report();
19450 +   /* drop _cat from display table; */
19451 +   %em_getname(key=repTopics, type=data);
19452 +   %EM_GETNAME(KEY=GRAPH_TABLE, TYPE=DATA);
19454 +   /* Generate reports for terms with term weights */
19455 +   %em_checkmacro(name=tmm_num_display_terms,      global=Y, value=20000);
19457 +   %EM_GETNAME(KEY=GRAPH_TABLE, TYPE=DATA);
19458 +   %EM_GETNAME(KEY=TOPICS, TYPE=DATA);
19459 +   %EM_GETNAME(KEY=SVDU, TYPE=DATA);
19460 +   %em_getname(key=termtopics,       type=data);
19461 +   %EM_GETNAME(KEY=weightedterms, TYPE=DATA);
19462 +  /* Get number of topics */
19463 +   proc sql noprint; select count(*) into :_n_topics from &em_user_topics; quit;
19464 +      %let _n_topics=%kleft(&_n_topics);
19465 +   proc sort data=&em_user_termtopics; by _termid _topicid;
19466 +   data &em_user_svdu(drop=_i _topicid _weight);
19467 +     retain topic1-topic&_n_topics;
19468 +     array _topics{*} topic1-topic&_n_topics;
19469 +     set &em_user_termtopics; by _termid;
19470 +      if first._termid then do;
19471 +         do _i=1 to &_n_topics; _topics{_i}=0; end;
19472 +         end;
19473 +      _topics{_topicid}=_weight;
19474 +      if last._termid then output;
19475 +      run;
19476 +   filename temp catalog "sashelp.emtxtext.apply_labels.source";
19477 +   %include temp;
19478 +   %apply_labels(&EM_USER_SVDU,&EM_USER_TOPICS,prefix=topic);
19480 +  /* include graphing macros */
19481 +   FILENAME TEMP CATALOG 'SASHELP.EMTXTEXT.TM_GRAPHS.SOURCE';
19482 +   %INCLUDE TEMP;
19483 +   /* get the top level terms */
19484 +   %GRAPH_TOP_TERMS(KEY=GRAPH_TABLE, MAXTERMS=20000, KEEPKEY=Y,
19485 +                 termds=&em_user_weightedterms);
19486 +   /* merge terms table with col values */
19487 +    proc sql noprint;
19488 +        create table &em_user_graph_table(drop=key _id_) as
19489 +            select a.*, b.* from &em_user_graph_table(drop=_ispar parent_id) a
19490 +            left join &em_user_svdu b on a.key=b._termid order by numdocs desc,
19491 +           term, rolestring;
19492 +    quit;
19494 +    /* can have 2+ SVD values to create matrix with */
19495 +    %let Yvars=Y1=topic1, Y2=topic2;
19496 +    %do i=3 %to %sysfunc(MIN(&_n_topics, 5));
19497 +        %let Yvars=&Yvars , Y&i=topic&i;
19498 +    %end;
19500 +    %let desc = %sysfunc(sasmsg(sashelp.tmine, rpt_text_topicterms_title, NOQUOTE));
19501 +    %EM_REPORT(KEY=GRAPH_TABLE, VIEWTYPE=MATRIXPLOT, DESCRIPTION= %nrbquote(&desc), AUTODISPLAY=Y,
19502 +        &Yvars. , COLOR=RANK, TIP=TERM);
19504 +   %let desc = %sysfunc(sasmsg(sashelp.tmine, rpt_text_topics_title, NOQUOTE));
19505 +   %em_report(key=reptopics, viewtype=DATA,
19506 +              description=%nrbquote(&desc), autodisplay=Y);
19508 +   %let desc = %sysfunc(sasmsg(sashelp.tmine, rpt_text_termsbytopic_title, NOQUOTE));
19509 +   %em_report(key=reptopics, viewtype=BAR, x=_topicid, freq=_numterms, tiptext=_name,
19510 +              group=_displayCat, sortorder=desc, description=%nrbquote(&desc),
19511 +              autodisplay=Y);
19513 +   %let desc = %sysfunc(sasmsg(sashelp.tmine, rpt_text_docsbytopic_title, NOQUOTE));
19514 +   %em_report(key=reptopics, viewtype=BAR, x=_topicid, freq=_numdocs, tiptext=_name,
19515 +              group=_displayCat,  sortorder=desc, description=%nrbquote(&desc),
19516 +              autodisplay=Y);
19518 +   %let desc = %sysfunc(sasmsg(sashelp.tmine, rpt_text_prescore_title, NOQUOTE));
19519 +   %EM_REPORT(KEY=PRESCORECODE, VIEWTYPE=SOURCE, DESCRIPTION=%nrbquote(&desc),
19520 +              BLOCK=Scoring, AUTODISPLAY=N);
19522 +%mend report;
NOTE: %INCLUDE (level 1) ending.
NOTE: PROCEDURE SQL used (Total process time):
      real time           0.00 seconds
      cpu time            0.00 seconds
      


NOTE: There were 7875 observations read from the data set EMWS1.TEXTTOPIC_TERMTOPICS.
NOTE: The data set EMWS1.TEXTTOPIC_TERMTOPICS has 7875 observations and 3 variables.
NOTE: PROCEDURE SORT used (Total process time):
      real time           0.03 seconds
      cpu time            0.01 seconds
      


NOTE: There were 7875 observations read from the data set EMWS1.TEXTTOPIC_TERMTOPICS.
NOTE: The data set EMWS1.TEXTTOPIC_SVDU has 1575 observations and 6 variables.
NOTE: DATA statement used (Total process time):
      real time           0.05 seconds
      cpu time            0.03 seconds
      

NOTE: %INCLUDE (level 1) file TEMP is file SASHELP.EMTXTEXT.APPLY_LABELS.SOURCE.
19523 +/* ****************************************************************
19524 + * Copyright (C) 2013 by SAS Institute Inc., Cary, NC 27513
19525 + *
19526 + * Name:             apply_labels.sas
19527 + * Support:          cox  James A. Cox
19528 + * Product:          SAS Text Miner
19529 + * Language:         Sas
19530 + * Script:
19531 + *
19532 + * Usage:
19533 + *
19534 + * Purpose: to apply descriptions from one data set as labels to a list of
19535 + *        variables in another
19536 + *
19537 + * History:
19538 + * 07Aug13 Initial Coding [cox]
19539 + *
19540 + * Notes:
19541 + *
19542 + * Last Modified By:
19543 + * Last Modified On: Fri Aug 30 16:22:02 2013
19544 + *
19545 + * End
19546 + * ************************************************************** */
19547 +%macro apply_labels(inds,labelds,label_col=_name,col_id=_topicid,prefix=COL,outds=);
19548 +%if &outds= %then %let outds=&inds;
19549 +proc sql noprint;
19550 +    select max(&col_id), min(&col_id) into :_maxvar, :_minvar from &labelds;
19551 +       quit;
19552 +%if &_minvar eq . %then %let _minvar=1;
19553 +%let _minvar=%left(&_minvar);
19554 +%let _maxvar=%left(&_maxvar);
19555 +
19556 +/* Do the following if there are any vars to be scored */
19557 +%if &_maxvar >0 %then %do;
19558 +
19559 +%let _minlab=%ktrim(_tmlab)&_minvar;
19560 +%let _maxlab=%ktrim(_tmlab)&_maxvar;
19561 +proc sql noprint;
19562 +    select &label_col into :&_minlab - :&_maxlab from &labelds;
19563 +       quit;
19564 +data &outds;
19565 +   set &inds;
19566 +   array vars{&_minvar:&_maxvar} &prefix.&_minvar-&prefix.&_maxvar;
19567 +         %do i=&_minvar %to &_maxvar;
19568 +            %let _tm_tmp=%bquote(&&_tmlab&i);
19569 +            label &prefix.&i="&_tm_tmp";
19570 +            %end;
19571 +
19572 +         %end;
19573 +run;
19574 +
19575 +%mend;
19576 +/*
19577 + * Example code;
19578 +
19579 +%let num_vars=20;
19580 + data vars(drop=j);
19581 +   array cols{&num_vars} col1-col&num_vars;
19582 +   do i=1 to 10;
19583 +      do j=1 to &num_vars;
19584 +         cols{j}=ranuni(0);
19585 +         end;
19586 +      output;
19587 +      end;
19588 +   run;
19589 + data labels;
19590 +    do i=1 to 20;
19591 +       label = "a"||put(i,2.);
19592 +       output;
19593 +       end;
19594 +run;
19595 +
19596 +   filename temp catalog "sashelp.emtxtext.apply_labels.source";
19597 +   %include temp;
19598 +%apply_labels(vars,labels,label_col=label,col_id=i,prefix=col);
19599 +
19600 +*/
NOTE: %INCLUDE (level 1) ending.
NOTE: PROCEDURE SQL used (Total process time):
      real time           0.00 seconds
      cpu time            0.00 seconds
      

NOTE: PROCEDURE SQL used (Total process time):
      real time           0.00 seconds
      cpu time            0.01 seconds
      


NOTE: There were 1575 observations read from the data set EMWS1.TEXTTOPIC_SVDU.
NOTE: The data set EMWS1.TEXTTOPIC_SVDU has 1575 observations and 6 variables.
NOTE: DATA statement used (Total process time):
      real time           0.01 seconds
      cpu time            0.00 seconds
      

NOTE: %INCLUDE (level 1) file TEMP is file SASHELP.EMTXTEXT.TM_GRAPHS.SOURCE.
19601 +%MACRO GRAPH_TOP_TERMS(KEY=, MAXTERMS=ALL, FILTER=N, KEEPKEY=N, termds=);
19602 +/*
19603 + * A gtable of all "top-level" terms, that is, all terms that do not have a different term as a parent.  This
19604 + * table would be linked to all graphs in this window such that the rows in the table are selected when points
19605 + * representing those terms are selected in the graphs.
19606 + */
19607 +
19608 +   %em_getname(key=&key);
19609 +   %LOCAL GRAPH_DATA;
19610 +   %LET GRAPH_DATA = &&EM_USER_&KEY;
19611 +   %if ^%symexist(tm_debug) %then %let tm_debug=0;
19612 +   %if "&FILTER"="Y" %then %do;
19613 +       %em_getname(key=terms_tmf, type=data);
19614 +       * sort by freq for the reports graph ;
19615 +       proc sort data=&EM_USER_TERMS_tmf out=_sortedTerms;
19616 +          by descending numdocs;
19617 +       run;
19618 +   %end;
19619 +   %else %do;
19620 +      %if &termds= %then %do;
19621 +         %let termds=&em_user_terms;
19622 +         %em_getname(key=terms, type=data);
19623 +         %end;
19624 +
19625 +       * sort by freq for the reports graph ;
19626 +       proc sort data=&termds out=_sortedTerms;
19627 +          by descending numdocs;
19628 +       run;
19629 +   %end;
19630 +
19631 +
19632 +   data &GRAPH_DATA;
19633 +      FORMAT TERM $256.;
19634 +      SET _sortedTerms(drop=PARENT %IF &keepkey=N %THEN KEY; where=(_ISPAR ne '.'));
19635 +      LABEL ROLESTRING= "%sysfunc(sasmsg(sashelp.tmine, rpt_text_role_vlabel,NOQUOTE))"
19636 +            NUMDOCS=    "%sysfunc(sasmsg(sashelp.tmine, rpt_text_numdocs_vlabel,   NOQUOTE))"
19637 +            RANK= "%sysfunc(sasmsg(sashelp.tmine, rpt_text_rank_vlabel,   NOQUOTE))"
19638 +            FREQ=       "%sysfunc(sasmsg(sashelp.tmine, rpt_text_freq_vlabel,      NOQUOTE))"
19639 +            ATTRSTRING=  "%sysfunc(sasmsg(sashelp.tmine, rpt_text_attribute_vlabel, NOQUOTE))"
19640 +            %if "&FILTER"="Y" %then %do;
19641 +                WEIGHT          = "%sysfunc(sasmsg(sashelp.tmine, rpt_text_weight_vlabel,             NOQUOTE))"
19642 +           %end;
19643 +            KEEP=       "%sysfunc(sasmsg(sashelp.tmine, rpt_text_keep_vlabel,      NOQUOTE))"
19644 +            PARENT_ID=  "%sysfunc(sasmsg(sashelp.tmine, rpt_text_parentid_vlabel,  NOQUOTE))"
19645 +            _ISPAR=     "%sysfunc(sasmsg(sashelp.tmine, rpt_text_isparent_vlabel,  NOQUOTE))";
19646 +       drop ROLE ATTRIBUTE;
19647 +      /* mark the parents */
19648 +      IF _ISPAR = '+' THEN TERM = '+ ' || TERM;
19649 +       %if "%upcase(&MAXTERMS)" ne "ALL" %then %do;
19650 +           if _N_<=&maxterms then output;
19651 +       %end;
19652 +    run;
19653 +
19654 +
19655 +
19656 +    proc rank data=&graph_data out=&graph_data descending ties=low;
19657 +       var numdocs;
19658 +       ranks Rank;
19659 +    run;
19660 +
19661 +
19662 +
19663 +
19664 +
19665 +    %if &tm_debug =0 %then %do;
19666 +       proc datasets lib=work nolist;
19667 +          delete _sortedTerms ;
19668 +       run;
19669 +    %end;
19670 +
19671 +
19672 +    quit;
19673 +
19674 +
19675 +   %let block = %sysfunc(sasmsg(sashelp.tmine, rpt_text_terms_title, NOQUOTE));
19676 +
19677 +   %let desc = %sysfunc(sasmsg(sashelp.tmine, rpt_text_terms_title, NOQUOTE));
19678 +   %EM_REPORT(KEY=&KEY, VIEWTYPE=DATA, DESCRIPTION= %nrbquote(&desc), BLOCK= %nrbquote(&block), AUTODISPLAY=Y, where=%str(KEEP='Y'));
19679 +
19680 +%MEND GRAPH_TOP_TERMS;
NOTE: %INCLUDE (level 1) ending.

NOTE: There were 1575 observations read from the data set EMWS1.TEXTTOPIC_WEIGHTEDTERMS.
NOTE: The data set WORK._SORTEDTERMS has 1575 observations and 13 variables.
NOTE: PROCEDURE SORT used (Total process time):
      real time           0.00 seconds
      cpu time            0.01 seconds
      


NOTE: Variable RANK is uninitialized.
NOTE: There were 1575 observations read from the data set WORK._SORTEDTERMS.
      WHERE _ISPAR not = '.';
NOTE: The data set EMWS1.TEXTTOPIC_GRAPH_TABLE has 1575 observations and 10 variables.
NOTE: DATA statement used (Total process time):
      real time           0.05 seconds
      cpu time            0.03 seconds
      


NOTE: The data set EMWS1.TEXTTOPIC_GRAPH_TABLE has 1575 observations and 11 variables.
NOTE: PROCEDURE RANK used (Total process time):
      real time           0.01 seconds
      cpu time            0.00 seconds
      


NOTE: The data set WORK.EM_USER_REPORT has 133 observations and 4 variables.
NOTE: DATA statement used (Total process time):
      real time           0.03 seconds
      cpu time            0.01 seconds
      

WARNING: This CREATE TABLE statement recursively references the target table. A consequence of this is a possible data integrity problem.
WARNING: The variable _id_ in the DROP, KEEP, or RENAME list has never been referenced.
NOTE: Table EMWS1.TEXTTOPIC_GRAPH_TABLE created, with 1575 rows and 14 columns.

NOTE: PROCEDURE SQL used (Total process time):
      real time           0.05 seconds
      cpu time            0.04 seconds
      


NOTE: There were 133 observations read from the data set WORK.EM_USER_REPORT.
NOTE: The data set WORK.EM_USER_REPORT has 265 observations and 4 variables.
NOTE: DATA statement used (Total process time):
      real time           0.03 seconds
      cpu time            0.01 seconds
      


NOTE: There were 265 observations read from the data set WORK.EM_USER_REPORT.
NOTE: The data set WORK.EM_USER_REPORT has 397 observations and 4 variables.
NOTE: DATA statement used (Total process time):
      real time           0.03 seconds
      cpu time            0.03 seconds
      


NOTE: There were 397 observations read from the data set WORK.EM_USER_REPORT.
NOTE: The data set WORK.EM_USER_REPORT has 529 observations and 4 variables.
NOTE: DATA statement used (Total process time):
      real time           0.03 seconds
      cpu time            0.03 seconds
      


NOTE: There were 529 observations read from the data set WORK.EM_USER_REPORT.
NOTE: The data set WORK.EM_USER_REPORT has 661 observations and 4 variables.
NOTE: DATA statement used (Total process time):
      real time           0.05 seconds
      cpu time            0.04 seconds
      


NOTE: There were 661 observations read from the data set WORK.EM_USER_REPORT.
NOTE: The data set WORK.EM_USER_REPORT has 793 observations and 4 variables.
NOTE: DATA statement used (Total process time):
      real time           0.04 seconds
      cpu time            0.03 seconds
      

19681  *------------------------------------------------------------*;
19682  * End REPORT: TextTopic;
19683  *------------------------------------------------------------*;
19684  

19685  /* Reset EM Options */
19686  options formchar="|----|+|---+=|-/\<>*";
19687  options nocenter ls=256 ps=10000;
19688  goptions reset=all device=GIF NODISPLAY;

19689  proc sort data=WORK.EM_USER_REPORT;
19690  by ID VIEW;
19691  run;

NOTE: There were 793 observations read from the data set WORK.EM_USER_REPORT.
NOTE: The data set WORK.EM_USER_REPORT has 793 observations and 4 variables.
NOTE: PROCEDURE SORT used (Total process time):
      real time           0.03 seconds
      cpu time            0.00 seconds
      

